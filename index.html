<html>

<head>
  <script src="https://unpkg.com/read-excel-file@4.x/bundle/read-excel-file.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="api.js"></script>
  <link rel="stylesheet" href="style.css">
  <!-- JavaScript Bundle with Popper -->
  <!-- CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
    crossorigin="anonymous"></script>
</head>

<body>
  <!-- <div class="contenedor_loader">
    <div class="loader"> </div>
  </div> -->
  <div class="contenedor_loader" id="contenedor">
    <div class="loader"> </div>
  </div>
  <div style="display: flex; align-items: center; margin-left: 10px; margin-top: 10px;">
    <input type="file" id="inputFile" accept=".xlsx" style="width: 50em;" />
  </div>
  <hr />
  <div style="display: flex; align-items: center; margin-left: 10px;">
    <table id="tbl-data"></table>
  </div>

  <div style="display: flex; align-items: center; margin-left: 10px; margin-top: 10px;">
    <button id="confirm" type="button" onclick="getTableData()">Save</button>
  </div>

  <script>

    var input = document.getElementById("inputFile");
    // console.log(input)
    // console.log(input.files[0])
    console.log(input.files.length);

    if (input.files.length == 0) {
      document.getElementById("confirm").disabled = true;
    }

    input.addEventListener("change", function () {
      readXlsxFile(input.files[0]).then(function (data) {
        var index = 0;
        console.log(input.files.length);
        if (input.files.length >= 1) {
          document.getElementById("confirm").disabled = false;
        }
        const indexEP = data.findIndex(numIndexEP => numIndexEP[1] === 'ENERGIA PORTEADA');
        // console.log(indexEP);
        var newData = []
        for (let x = indexEP + 1; x < data.length; x++) {
          const element = data[x];
          newData.push(element)
          // console.log(element);          
        }
        newData.reverse();
        // console.log(newData);
        const indexEN = newData.findIndex(numIndexEN => numIndexEN[1] === 'ENERGIA NORMAL POR FALTANTE');
        // console.log(indexEN);
        var lastData = []
        for (let i = indexEN + 1; i < newData.length; i++) {
          const element = newData[i];
          // console.log(element); 
          lastData.push(element)
        }
        lastData.reverse()
        // console.log(lastData);


        /*Create Table HEAD*/
        data.map((row, index) => {
          /* Elimina del arreglo todos los valores igualados a null*/
          var newRow = row.filter(function (e) { return e !== null })
          // console.log(newRow);            
          //  console.log(newRow);

          if (index == 0) {
            row.map((elemnt) => {
              if (elemnt !== null) {
                var table = document.getElementById("tbl-data");
                generateHeadTable(table, elemnt);
              }
            });
          }
        });

        /*Create Table ROWS*/
        lastData.map((row, index) => {
          // console.log((index - 5));
          var newRow = row.filter(function (e) { return e !== null })
          // console.log(newRow);
          var onlyCol = [] // Arreglo para separar las columnas
          var finalData = [] //Arreglo para hacer push de cada columna agregada

          for (let x = 1; x <= 13; x++) {
            const element = row[x];
            // console.log(element);
            onlyCol.push(element)

          }
          // console.log(onlyCol);
          for (let i = 0; i < 4; i++) {
            const element = onlyCol[i];
            // console.log(element);
            finalData.push(element)
          }
          for (let e = 5; e < 9; e++) {
            const element = onlyCol[e];
            // console.log(element);
            finalData.push(element)

          }

          let date = new Date();
          let output = String(date.getDate()).padStart(2, '0') + '/' + String(date.getMonth() + 1).padStart(2, '0') + '/' + date.getFullYear();
          var dateComp = output.split('/')

          for (let j = 12; j < 13; j++) { //Inserta al arreglo final la fecha
            const element = onlyCol[j];
            var fecha, division, mesprev, mes, anio, comparacion
            // console.log(element == undefined ? '' : element);
            // console.log(element.toDateString());
            if (element !== null) {
              // console.log(new Date(element).toLocaleDateString());
              fecha = new Date(element).toLocaleDateString()
              division = fecha.split('/')
              mesprev = division[0]
              comparacion = parseInt(mesprev)
              if (comparacion <= dateComp[1]) {
                mes = division[0]
              }
              if (comparacion > dateComp[1]) {
                {
                  mes = division[1]
                }
              }
              anio = division[2]
            }
            // console.log('El mes es ' + mes + ' y el aÃ±o es ' + anio);

            finalData.push(mes)
            finalData.push(anio)
          }
          // console.log(finalData);
          if (index >= 0) {
            var table = document.getElementById("tbl-data");
            // console.log('rows: ', table.rows.length);
            generateTableRow(table, finalData);
          }
          index++;
        })
      });

    });

    function generateHeadTable(table, data) {
      var tHead = table.createTHead();
      var row = tHead.insertRow();
      for (var key of data) {
        var th = document.createElement("th");
        var text = document.createTextNode(key);
        th.appendChild(text);
        row.appendChild(th);
      }
    }

    function generateTableRow(table, data) {

      var newRow = table.insertRow(-1);
      data.map((row, index) => {
        var cell = newRow.insertCell();
        var text = document.createTextNode(row);
        cell.appendChild(text);
      });

    }

  </script>
</body>

</html>